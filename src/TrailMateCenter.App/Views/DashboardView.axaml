<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:TrailMateCenter.ViewModels"
             xmlns:mapsui="using:Mapsui.UI.Avalonia"
             x:Class="TrailMateCenter.Views.DashboardView"
             x:DataType="vm:MainWindowViewModel">
  <Grid ColumnDefinitions="260,*,340" RowDefinitions="*">
    <Border Background="{DynamicResource PanelBg2}" BorderBrush="{DynamicResource PanelBorder}" BorderThickness="0,0,1,0" Classes="panel">
      <Grid RowDefinitions="Auto,Auto,Auto,*">
        <ToggleButton x:Name="TeamToggle" Grid.Row="0" Classes="sectionHeader" IsChecked="True" HorizontalAlignment="Stretch">
          <Grid ColumnDefinitions="*,Auto">
            <TextBlock Text="{DynamicResource Ui.Dashboard.Team}" FontWeight="Bold" Foreground="{DynamicResource TextPrimary}"/>
            <TextBlock Grid.Column="1" Text="▾" Margin="6,0,0,0" Foreground="{DynamicResource TextDim}"/>
          </Grid>
        </ToggleButton>
        <Border Grid.Row="1" Background="Transparent" Padding="0,6,0,8"
                IsVisible="{Binding IsChecked, ElementName=TeamToggle}">
          <Grid RowDefinitions="Auto,*">
            <TextBlock Text="{DynamicResource Ui.Dashboard.NoTeams}" Foreground="{DynamicResource TextDim}" FontSize="10" Margin="8,4"
                       IsVisible="{Binding HasNoTeams}"/>
            <ListBox Grid.Row="1"
                     ItemsSource="{Binding Teams}"
                     ItemTemplate="{StaticResource TeamGroupTemplate}"
                     IsVisible="{Binding HasTeams}"
                     Background="Transparent"
                     BorderThickness="0"
                     HorizontalAlignment="Stretch"/>
          </Grid>
        </Border>

        <ToggleButton x:Name="NodeToggle" Grid.Row="2" Classes="sectionHeader" IsChecked="True" HorizontalAlignment="Stretch">
          <Grid ColumnDefinitions="*,Auto">
            <TextBlock Text="{DynamicResource Ui.Dashboard.NodeList}" FontWeight="Bold" Foreground="{DynamicResource TextPrimary}"/>
            <TextBlock Grid.Column="1" Text="▾" Margin="6,0,0,0" Foreground="{DynamicResource TextDim}"/>
          </Grid>
        </ToggleButton>
        <Border Grid.Row="3" Background="Transparent" Padding="0,6,0,8"
                IsVisible="{Binding IsChecked, ElementName=NodeToggle}">
          <ListBox ItemsSource="{Binding UngroupedSubjects}" SelectedItem="{Binding SelectedSubject}"
                   ItemTemplate="{StaticResource SubjectTemplate}"
                   Background="{DynamicResource PanelBg2}"
                   BorderThickness="0"
                   HorizontalAlignment="Stretch"/>
        </Border>
      </Grid>
    </Border>

    <Grid Grid.Column="1" RowDefinitions="*,220" Margin="0">
      <Border Background="{DynamicResource SurfaceDark}" BorderBrush="{DynamicResource PanelBorder}" BorderThickness="0,0,1,0" Classes="panel">
        <Grid>
          <mapsui:MapControl x:Name="MainMapControl" Map="{Binding Map.Map}" />
          <Canvas IsHitTestVisible="False">
            <Polyline x:Name="OfflineSelectionPolygon"
                      IsVisible="False"
                      Stroke="#FF53C7FF"
                      StrokeThickness="2"
                      Fill="Transparent"/>
          </Canvas>
          <Border IsHitTestVisible="False" Background="{StaticResource MapGridBrush}" Opacity="0.08"/>
          <Border IsHitTestVisible="False" Background="{StaticResource MapNoiseBrush}" Opacity="0.04"/>
          <Border IsHitTestVisible="False" Background="{StaticResource MapVignette}" Opacity="0.2"/>
          <Border HorizontalAlignment="Left" VerticalAlignment="Top" Margin="12"
                  Background="{DynamicResource PanelBg}" BorderBrush="{DynamicResource PanelBorder}"
                  BorderThickness="1" CornerRadius="6" Padding="8" Opacity="0.95">
            <StackPanel Spacing="6">
              <StackPanel Orientation="Horizontal" Spacing="10">
                <CheckBox Content="{DynamicResource Ui.Dashboard.Cluster}" IsChecked="{Binding MapEnableCluster}" Foreground="{DynamicResource TextPrimary}"/>
                <CheckBox Content="{DynamicResource Ui.Dashboard.Follow}" IsChecked="{Binding MapFollowLatest}" Foreground="{DynamicResource TextPrimary}"/>
                <CheckBox Content="{DynamicResource Ui.Dashboard.OfflineMode}" IsChecked="{Binding OfflineMode}" Foreground="{DynamicResource TextPrimary}"/>
                <CheckBox Content="{DynamicResource Ui.Dashboard.Logs}" IsChecked="{Binding MapShowLogs}" Foreground="{DynamicResource TextPrimary}"/>
                <CheckBox Content="{DynamicResource Ui.Dashboard.Mqtt}"
                          IsChecked="{Binding MapShowMqtt}"
                          IsEnabled="{Binding CanUseExternalFeeds}"
                          Foreground="{DynamicResource TextPrimary}"/>
                <CheckBox Content="{DynamicResource Ui.Dashboard.ContoursLabel}" IsChecked="{Binding ContoursEnabled}" Foreground="{DynamicResource TextPrimary}"/>
                <CheckBox Content="{DynamicResource Ui.Dashboard.Gibs}" IsChecked="{Binding MapShowGibs}" Foreground="{DynamicResource TextPrimary}"/>
              </StackPanel>
              <TextBlock Text="{DynamicResource Ui.Dashboard.OfflineModeHint}"
                         Foreground="{DynamicResource AccentWarn}"
                         FontSize="10"
                         IsVisible="{Binding OfflineMode}"/>
              <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="{DynamicResource Ui.Dashboard.BaseMap}" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimary}"/>
                <ComboBox Width="140"
                          ItemsSource="{Binding MapBaseLayers}"
                          SelectedItem="{Binding SelectedMapBaseLayer}"/>
              </StackPanel>
              <TextBlock Text="{Binding Map.CurrentZoomText}" Foreground="{DynamicResource TextPrimary}" FontSize="10"/>
              <TextBlock Text="{Binding Map.CurrentContourText}" Foreground="{DynamicResource TextDim}" FontSize="10"/>
              <TextBlock Text="{Binding Map.OfflineCacheStatusText}" Foreground="{DynamicResource TextDim}" FontSize="10" TextWrapping="Wrap" MaxWidth="520"/>
            </StackPanel>
          </Border>
          <Border HorizontalAlignment="Right" VerticalAlignment="Top" Margin="12"
                  Background="#0F1C2C"
                  BorderBrush="#6F8FB5"
                  BorderThickness="1"
                  CornerRadius="6"
                  Padding="4"
                  Opacity="1">
            <StackPanel Spacing="4">
              <ToggleButton x:Name="OfflineCacheSelectToggle"
                            Width="36"
                            Height="36"
                            Padding="6"
                            Background="#EAF2FC"
                            BorderBrush="#8DA8C7"
                            BorderThickness="1"
                            IsChecked="{Binding Map.IsOfflineCacheSelectionMode}"
                            ToolTip.Tip="{DynamicResource Ui.Dashboard.OfflineCacheSelect}">
                <Image Source="/Assets/kuangxuan.png"
                       Width="20"
                       Height="20"
                       Stretch="Uniform"/>
              </ToggleButton>
              <Button Width="36"
                      Height="36"
                      Padding="6"
                      Background="#EAF2FC"
                      BorderBrush="#8DA8C7"
                      BorderThickness="1"
                      Click="OnOfflineCacheRegionsClicked"
                      ToolTip.Tip="{DynamicResource Ui.Dashboard.OfflineCacheRegionsOpen}">
                <Image Source="/Assets/liebiao.png"
                       Width="20"
                       Height="20"
                       Stretch="Uniform"/>
              </Button>
              <Button Width="36"
                      Height="36"
                      Padding="6"
                      Background="#EAF2FC"
                      BorderBrush="#8DA8C7"
                      BorderThickness="1"
                      Click="OnImportTrackClicked"
                      ToolTip.Tip="{DynamicResource Ui.Dashboard.ImportTrack}">
                <Image Source="/Assets/locus-full.png"
                       Width="20"
                       Height="20"
                       Stretch="Uniform"/>
              </Button>
            </StackPanel>
          </Border>
          <Border HorizontalAlignment="Left" VerticalAlignment="Bottom" Margin="12"
                  Background="{DynamicResource SurfaceDark}" BorderBrush="{DynamicResource PanelBorder}"
                  BorderThickness="1" CornerRadius="6" Padding="8" Opacity="0.92"
                  IsVisible="{Binding MapShowLogs}"
                  PointerWheelChanged="OnMapLogPanelPointerWheelChanged">
            <ScrollViewer MaxHeight="160"
                          Width="360"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          IsScrollChainingEnabled="False">
              <ItemsControl ItemsSource="{Binding Map.MapLogEntries}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding Message}" Foreground="{Binding Color}" FontSize="10" TextWrapping="Wrap"/>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </Border>
        </Grid>
      </Border>
      <Border Grid.Row="1" Background="{DynamicResource PanelBg}" BorderBrush="{DynamicResource PanelBorder}" BorderThickness="1,1,1,0" Padding="8" Classes="panel">
        <Grid RowDefinitions="Auto,*">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <Button Content="{DynamicResource Ui.Dashboard.Filter.Info}" Width="60"/>
            <Button Content="{DynamicResource Ui.Dashboard.Filter.Warn}" Width="60"/>
            <Button Content="{DynamicResource Ui.Dashboard.Filter.Crit}" Width="60"/>
          </StackPanel>
          <ListBox Grid.Row="1" ItemsSource="{Binding TacticalEvents}" SelectedItem="{Binding SelectedTacticalEvent}"
                   ItemTemplate="{StaticResource TacticalEventTemplate}"
                   Background="{DynamicResource PanelBg2}"
                   BorderBrush="{DynamicResource PanelBorder}"
                   BorderThickness="1"/>
        </Grid>
      </Border>
    </Grid>

    <Border Grid.Column="2" Background="{DynamicResource PanelBg2}" BorderBrush="{DynamicResource PanelBorder}" BorderThickness="1,0,0,0" Classes="panel">
      <Grid RowDefinitions="Auto,*,Auto">
        <Border Background="{DynamicResource PanelBg}" BorderBrush="{DynamicResource PanelBorder}" BorderThickness="0,0,0,1" Padding="10" Classes="panel">
          <StackPanel Spacing="6">
            <TextBlock Text="{DynamicResource Ui.Dashboard.Broadcast}" Foreground="{DynamicResource TextPrimary}" FontWeight="Bold"/>
            <TextBox Watermark="{DynamicResource Ui.Dashboard.InputMessage}" Text="{Binding OutgoingText, UpdateSourceTrigger=PropertyChanged}" Height="40"/>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBox Width="70" Text="{Binding Target, UpdateSourceTrigger=PropertyChanged}" Watermark="{DynamicResource Ui.Dashboard.Target}"/>
              <ComboBox Width="80" ItemsSource="{Binding Channels}" SelectedItem="{Binding SelectedChannel}"/>
              <Button Content="{DynamicResource Ui.Dashboard.Send}" Command="{Binding SendCommand}" Classes="primary" MinWidth="80"/>
            </StackPanel>
          </StackPanel>
        </Border>
        <Border Grid.Row="1" Background="{DynamicResource PanelBg}" BorderBrush="{DynamicResource PanelBorder}" BorderThickness="0,0,0,1" Padding="8" Classes="panel">
          <StackPanel>
            <TextBlock Text="{DynamicResource Ui.Dashboard.EventStream}" FontWeight="Bold" Foreground="{DynamicResource TextPrimary}" Margin="0,0,0,6"/>
            <ListBox ItemsSource="{Binding TacticalEvents}"
                     SelectedItem="{Binding SelectedTacticalEvent}"
                     ItemTemplate="{StaticResource TacticalEventTemplate}"
                     Background="{DynamicResource PanelBg2}"
                     BorderBrush="{DynamicResource PanelBorder}"
                     BorderThickness="1"/>
          </StackPanel>
        </Border>
        <Border Grid.Row="2" Background="{DynamicResource PanelBg2}" BorderBrush="{DynamicResource PanelBorder}" BorderThickness="0,1,0,0" Padding="10" Classes="panel">
          <StackPanel Spacing="6">
            <TextBlock Text="{DynamicResource Ui.Dashboard.CommandOps}" FontWeight="Bold" Foreground="{DynamicResource TextPrimary}"/>
            <TextBlock Text="{Binding SelectedSubjectDisplayId}" Foreground="{DynamicResource TextPrimary}"/>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="{DynamicResource Ui.Dashboard.Channel}" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimary}"/>
              <TextBox Width="50" Text="{Binding CommandChannel}"/>
              <TextBlock Text="{DynamicResource Ui.Dashboard.Radius}" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimary}"/>
              <TextBox Width="60" Text="{Binding CommandRadiusMeters}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="{DynamicResource Ui.Dashboard.Priority}" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimary}"/>
              <TextBox Width="60" Text="{Binding CommandPriority}"/>
            </StackPanel>
            <TextBox Watermark="{DynamicResource Ui.Dashboard.Note}" Text="{Binding CommandNote}"/>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <Button Content="{DynamicResource Ui.Dashboard.Command.RallyTo}" Command="{Binding RallyCommand}"/>
              <Button Content="{DynamicResource Ui.Dashboard.Command.MoveTo}" Command="{Binding MoveCommand}"/>
              <Button Content="{DynamicResource Ui.Dashboard.Command.Hold}" Command="{Binding HoldCommand}"/>
            </StackPanel>
            <TextBlock Text="{DynamicResource Ui.Dashboard.CommandHint}" Foreground="{DynamicResource TextDim}" FontSize="10"/>
          </StackPanel>
        </Border>
      </Grid>
    </Border>
  </Grid>
</UserControl>
